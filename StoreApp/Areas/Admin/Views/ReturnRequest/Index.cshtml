@model StoreApp.Areas.Admin.Controllers.AdminReturnRequestListVm
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="container my-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h5 class="mb-0"><i class="fa fa-undo me-2"></i> İade Talepleri</h5>
        <a asp-area="Admin" asp-controller="ReturnRequest" asp-action="Index" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-rotate-left me-1"></i> Sıfırla
        </a>
    </div>

    <form method="get" class="row g-2 mb-3">
        <div class="col-md-3">
           <select class="form-select" asp-for="Status">
    <option value="">Tüm Durumlar</option>
    <option value="Pending">Beklemede</option>
    <option value="Approved">Onaylandı</option>
    <option value="Rejected">Reddedildi</option>
    <option value="Completed">Tamamlandı</option>
</select>

        </div>
        <div class="col-md-3">
            <input class="form-control" type="number" name="orderId" value="@(Model.OrderId?.ToString() ?? "")" placeholder="Sipariş No" />
        </div>
        <div class="col-md-3">
            <input class="form-control" type="text" name="email" value="@Model.Email" placeholder="Kullanıcı e-posta" />
        </div>
        <div class="col-md-3 d-grid">
            <button class="btn btn-primary"><i class="fa fa-search me-1"></i> Filtrele</button>
        </div>
    </form>

    @if (!Model.Items.Any())
    {
        <div class="alert alert-light text-center py-5">
            <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
            <h6>Kayıt bulunamadı.</h6>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Sipariş</th>
                        <th>Ürün(ler)</th>
                        <th>Neden</th>
                        <th>Talep Tarihi</th>
                        <th>Durum</th>
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var r in Model.Items)
                {
                    var statusBadge = r.Status switch
                    {
                        Entities.Models.ReturnStatus.Pending => "bg-warning text-dark",
                        Entities.Models.ReturnStatus.Approved => "bg-success",
                        Entities.Models.ReturnStatus.Rejected => "bg-danger",
                        Entities.Models.ReturnStatus.Completed => "bg-primary",
                        _ => "bg-secondary"
                    };
                    <tr>
                        <td class="fw-semibold">#@r.ReturnRequestId</td>
                        <td>
                            <div class="d-flex flex-column">
                                <a asp-area="Admin" asp-controller="Order" asp-action="Detail" asp-route-id="@r.OrderId" class="text-decoration-none">#@r.OrderId</a>
                                <small class="text-muted">@r.Order?.Name</small>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var l in r.Lines)
                                {
                                    var p = l.CartLine?.Product;
                                    var img = string.IsNullOrWhiteSpace(p?.ImageUrl) ? "/images/placeholders/product-thumb.png" : p!.ImageUrl;
                                    <div class="d-flex align-items-center border rounded px-2 py-1">
                                        <img src="@img" style="width:32px;height:32px;object-fit:cover" class="rounded me-2" />
                                        <small>@(p?.ProductName ?? "Ürün") × @l.Quantity</small>
                                    </div>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <div class="fw-semibold">@r.Reason</div>
                                @if (!string.IsNullOrWhiteSpace(r.DetailedReason))
                                {
                                    <div class="text-muted">@r.DetailedReason</div>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                @r.RequestedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                                @if (r.ProcessedAt.HasValue)
                                {
                                    <div class="text-muted">İşl.: @r.ProcessedAt.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
                                }
                            </div>
                        </td>
                        <td><span class="badge @statusBadge">@r.Status</span></td>
                        <td class="text-end">
                            <div class="btn-group">
                                <a asp-area="Admin" asp-controller="ReturnRequest" asp-action="Detail" asp-route-id="@r.ReturnRequestId"
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fa fa-eye"></i> Görüntüle
                                </a>

                                <form method="post" asp-area="Admin" asp-controller="ReturnRequest" asp-action="Approve" class="d-inline js-rr-action ms-1">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@r.ReturnRequestId" />
                                    <input type="hidden" name="adminNotes" value="" />
                                    <button type="submit" class="btn btn-sm btn-success" @(r.Status != Entities.Models.ReturnStatus.Pending ? "disabled" : null)>
                                        <i class="fa fa-check"></i>
                                    </button>
                                </form>

                                <form method="post" asp-area="Admin" asp-controller="ReturnRequest" asp-action="Reject" class="d-inline js-rr-action ms-1">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@r.ReturnRequestId" />
                                    <input type="hidden" name="adminNotes" value="" />
                                    <button type="submit" class="btn btn-sm btn-danger" @(r.Status != Entities.Models.ReturnStatus.Pending ? "disabled" : null)
                                            onclick="return askRejectReason(this);">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </form>

                                <form method="post" asp-area="Admin" asp-controller="ReturnRequest" asp-action="Complete" class="d-inline js-rr-action ms-1">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@r.ReturnRequestId" />
                                    <button type="submit" class="btn btn-sm btn-primary" @(r.Status != Entities.Models.ReturnStatus.Approved ? "disabled" : null)>
                                        <i class="fa fa-flag-checkered"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        <nav class="mt-3">
            <ul class="pagination justify-content-end mb-0">
                @{
                    var prevDisabled = Model.Page <= 1 ? "disabled" : "";
                    var nextDisabled = Model.Page >= Model.TotalPages ? "disabled" : "";
                }
                <li class="page-item @prevDisabled">
                    <a class="page-link"
                       asp-route-status="@Model.Status"
                       asp-route-orderId="@Model.OrderId"
                       asp-route-email="@Model.Email"
                       asp-route-page="@(Model.Page - 1)"
                       asp-route-pageSize="@Model.PageSize">Önceki</a>
                </li>
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link"
                           asp-route-status="@Model.Status"
                           asp-route-orderId="@Model.OrderId"
                           asp-route-email="@Model.Email"
                           asp-route-page="@i"
                           asp-route-pageSize="@Model.PageSize">@i</a>
                    </li>
                }
                <li class="page-item @nextDisabled">
                    <a class="page-link"
                       asp-route-status="@Model.Status"
                       asp-route-orderId="@Model.OrderId"
                       asp-route-email="@Model.Email"
                       asp-route-page="@(Model.Page + 1)"
                       asp-route-pageSize="@Model.PageSize">Sonraki</a>
                </li>
            </ul>
        </nav>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function askRejectReason(btn){
    return Swal.fire({
        title: 'Red Nedeni',
        input: 'textarea',
        inputPlaceholder: 'Lütfen red gerekçesini yazın...',
        inputValidator: (v)=>!v ? 'Bu alan zorunludur' : undefined,
        showCancelButton: true,
        confirmButtonText: 'Gönder',
        cancelButtonText: 'Vazgeç'
    }).then(res=>{
        if(res.isConfirmed){
            const form = btn.closest('form');
            form.querySelector('input[name="adminNotes"]').value = res.value;
            return true;
        }
        return false;
    }).then(ok => !!ok);
}

document.querySelectorAll('.js-rr-action').forEach(f=>{
  f.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(this);
    fetch(this.action, {
      method: 'POST',
      body: fd,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        Swal.fire({icon:'success', title:'Başarılı', text:data.message, timer:1200, showConfirmButton:false})
          .then(()=>location.reload());
      }else{
        Swal.fire({icon:'error', title:'Hata', text:data.message});
      }
    })
    .catch(err=>{
      console.error(err);
      Swal.fire({icon:'error', title:'Hata', text:'İşlem sırasında bir hata oluştu.'});
    });
  });
});
</script>
