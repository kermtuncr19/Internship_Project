@model IEnumerable<Entities.Models.ProductStock>

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

@{
    var product = ViewBag.Product as Entities.Models.Product;
    var requiresSize = ViewBag.RequiresSize as bool? ?? false;
    var availableSizes = ViewBag.AvailableSizes as List<string> ?? new List<string>();
}

<div class="container-fluid py-4">
    <!-- BaÅŸlÄ±k -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ðŸ“¦ Stok YÃ¶netimi</h2>
            <p class="text-muted mb-0">@product?.ProductName</p>
        </div>
        <a asp-area="Admin" asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left me-2"></i>ÃœrÃ¼nlere DÃ¶n
        </a>
    </div>

    <!-- Bildirimler -->
    @if (TempData["success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Sol: Mevcut Stoklar -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-navy text-white">
                    <h5 class="mb-0"><i class="fa fa-warehouse me-2"></i>Mevcut Stoklar</h5>
                </div>
                <div class="card-body">
                    @if (!Model.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            Bu Ã¼rÃ¼n iÃ§in henÃ¼z stok kaydÄ± bulunmuyor.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        @if (requiresSize)
                                        {
                                            <th>Beden</th>
                                        }
                                        <th>Stok MiktarÄ±</th>
                                        <th>Son GÃ¼ncelleme</th>
                                        <th class="text-center">Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var stock in Model.OrderBy(s => s.Size))
                                    {
                                        <tr>
                                            <td><span class="badge bg-secondary">#@stock.ProductStockId</span></td>
                                            @if (requiresSize)
                                            {
                                                <td>
                                                    <span class="badge bg-primary fs-6">@(stock.Size ?? "Genel")</span>
                                                </td>
                                            }
                                            <td>
                                                @if (stock.Quantity == 0)
                                                {
                                                    <span class="badge bg-danger fs-6">TÃ¼kendi</span>
                                                }
                                                else if (stock.Quantity < 10)
                                                {
                                                    <span class="badge bg-warning text-dark fs-6">@stock.Quantity adet</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success fs-6">@stock.Quantity adet</span>
                                                }
                                            </td>
                                            <td class="text-muted small">
                                                @{
                                                    var displayDate = stock.UpdatedAt ?? stock.CreatedAt;
                                                    var localDate = displayDate.ToLocalTime();
                                                }
                                                @localDate.ToString("dd.MM.yyyy HH:mm")
                                            </td>
                                            <td>
                                                <div class="d-flex gap-2 justify-content-center">
                                                    <button type="button" class="btn btn-sm btn-warning" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#updateModal"
                                                            data-stock-id="@stock.ProductStockId"
                                                            data-size="@stock.Size"
                                                            data-quantity="@stock.Quantity">
                                                        <i class="fa fa-edit"></i>
                                                    </button>
                                                    <form asp-action="DeleteStock" method="post" class="d-inline delete-form">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="stockId" value="@stock.ProductStockId" />
                                                        <input type="hidden" name="productId" value="@product.ProductId" />
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="fa fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Toplam Stok Ã–zeti -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-1">Toplam Stok</h6>
                                    <h3 class="mb-0 text-navy">@Model.Sum(s => s.Quantity)</h3>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-1">KayÄ±t SayÄ±sÄ±</h6>
                                    <h3 class="mb-0 text-navy">@Model.Count()</h3>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-1">TÃ¼kenen</h6>
                                    <h3 class="mb-0 text-danger">@Model.Count(s => s.Quantity == 0)</h3>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- SaÄŸ: Yeni Stok Ekleme -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fa fa-plus-circle me-2"></i>Stok Ekle/GÃ¼ncelle</h5>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateStock" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@product.ProductId" />

                        @if (requiresSize && availableSizes.Any())
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">Beden</label>
                                <select name="size" class="form-select" required>
                                    <option value="">Beden seÃ§in...</option>
                                    @foreach (var size in availableSizes)
                                    {
                                        <option value="@size">@size</option>
                                    }
                                </select>
                            </div>
                        }
                        else
                        {
                            <input type="hidden" name="size" value="" />
                            <div class="alert alert-info mb-3">
                                <i class="fa fa-info-circle me-2"></i>
                                Bu Ã¼rÃ¼n bedensizdir.
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label fw-bold">Stok MiktarÄ±</label>
                            <input type="number" name="quantity" class="form-control" 
                                   min="0" value="0" required />
                            <div class="form-text">0 = TÃ¼kendi</div>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            <i class="fa fa-save me-2"></i>Kaydet
                        </button>
                    </form>

                    @if (requiresSize && availableSizes.Any())
                    {
                        <hr class="my-4" />
                        
                        <h6 class="fw-bold mb-3">
                            <i class="fa fa-magic me-2"></i>HÄ±zlÄ± Ä°ÅŸlem
                        </h6>
                        
                        <form asp-action="SetAllSizesStock" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@product.ProductId" />
                            
                            <div class="input-group mb-2">
                                <input type="number" name="quantity" class="form-control" 
                                       placeholder="Miktar" min="0" value="10" required />
                                <button type="submit" class="btn btn-primary">
                                    TÃ¼m Bedenlere Ata
                                </button>
                            </div>
                            <small class="text-muted">
                                TÃ¼m bedenlere aynÄ± stok miktarÄ±nÄ± atar
                            </small>
                        </form>
                    }
                </div>
            </div>

            <!-- ÃœrÃ¼n Bilgileri -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">ÃœrÃ¼n Bilgileri</h6>
                    <img src="@product?.ImageUrl" alt="@product?.ProductName" 
                         class="img-fluid rounded mb-3" />
                    <p class="mb-2"><strong>Fiyat:</strong> @product?.Price.ToString("C")</p>
                    <p class="mb-2"><strong>Kategori:</strong> @product?.Category?.CategoryName</p>
                    <p class="mb-0">
                        <strong>Beden:</strong> 
                        @if (requiresSize)
                        {
                            <span class="badge bg-success">Gerekli</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Yok</span>
                        }
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GÃ¼ncelleme Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stok GÃ¼ncelle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="UpdateStock" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="productId" value="@product.ProductId" />
                <input type="hidden" name="size" id="modal-size" />
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Beden</label>
                        <input type="text" class="form-control" id="modal-size-display" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Yeni Stok MiktarÄ±</label>
                        <input type="number" name="quantity" id="modal-quantity" 
                               class="form-control" min="0" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save me-2"></i>GÃ¼ncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Modal iÃ§in veri doldurma
        const updateModal = document.getElementById('updateModal');
        updateModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const size = button.getAttribute('data-size');
            const quantity = button.getAttribute('data-quantity');
            
            document.getElementById('modal-size').value = size || '';
            document.getElementById('modal-size-display').value = size || 'Bedensiz';
            document.getElementById('modal-quantity').value = quantity;
        });

        // Silme onayÄ±
        document.querySelectorAll('.delete-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: 'Bu stok kaydÄ± silinecek!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, sil',
                    cancelButtonText: 'VazgeÃ§',
                    confirmButtonColor: '#d33'
                }).then(result => {
                    if (result.isConfirmed) form.submit();
                });
            });
        });
    </script>
}

<style>
    .bg-navy {
        background-color: #001f54 !important;
    }
    .text-navy {
        color: #001f54 !important;
    }
</style>