@model StoreApp.Models.ProductListViewModel
@using Entities.Models

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

@{
    var activeId = ViewBag.ActiveCategoryId as int?;
    var cats = ViewBag.Categories as IEnumerable<Category>;

    // Query (filtre/paging)
    var qMin = Context.Request.Query["MinPrice"].ToString();
    var qMax = Context.Request.Query["MaxPrice"].ToString();
    var qSearch = Context.Request.Query["SearchTerm"].ToString();
    var qPageSize = Context.Request.Query["PageSize"].ToString();
}

@if (TempData["PriceError"] is string pe && !string.IsNullOrWhiteSpace(pe))
{
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
    @pe
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
  </div>
}

<div class="text-center mb-3">
    <div class="display-6">√úr√ºnler</div>
</div>

<!-- ‚úÖ KATEGORƒ∞ Pƒ∞LL‚ÄôLERƒ∞ + HEMEN YANINDA SEARCH + SAƒûDA Fƒ∞YAT -->
<div class="category-bar row align-items-center g-1 mb-3">

  <!-- Sol: Kategori pill ≈üeridi (yatay kaydƒ±rmalƒ±) -->
  <div class="col-12 col-lg order-1">
    <div class="chips d-flex flex-nowrap overflow-auto gap-2 pe-2">
      <a asp-area="Admin" asp-controller="Product" asp-action="Index"
         class="btn btn-sm rounded-pill px-3 @(activeId == null ? "btn-navy" : "btn-outline-navy")">
        T√ºm √úr√ºnler
      </a>

      @if (cats is not null)
      {
        foreach (var c in cats)
        {
          <a asp-area="Admin" asp-controller="Product" asp-action="Index"
             asp-route-CategoryId="@c.CategoryId"
             class="btn btn-sm rounded-pill px-3 @(activeId == c.CategoryId ? "btn-navy" : "btn-outline-navy")">
            @c.CategoryName
          </a>
        }
      }
    </div>
  </div>

  <!-- Orta: Search bar (pill'lere daha yakƒ±n) -->
  <div class="col-12 col-md-6 col-lg-5 order-2 mt-1 mt-lg-0">
    <form class="page-search" method="get"
          asp-area="Admin" asp-controller="Product" asp-action="Index" role="search">
      <div class="input-group nav-search w-100">
        <span class="input-group-text border-end-0"><i class="fa fa-search"></i></span>
        <input type="search"
               class="form-control border-start-0"
               name="SearchTerm"
               value="@(qSearch)"
               placeholder="√úr√ºn ara..."
               aria-label="Ara" />
        <button class="btn btn-navy d-none d-md-inline-flex" type="submit">Ara</button>

        @* Mevcut filtreleri koru *@
        @if (activeId.HasValue) { <input type="hidden" name="CategoryId" value="@activeId.Value" /> }
        @if (!string.IsNullOrWhiteSpace(qMin)) { <input type="hidden" name="MinPrice" value="@qMin" /> }
        @if (!string.IsNullOrWhiteSpace(qMax)) { <input type="hidden" name="MaxPrice" value="@qMax" /> }
        @if (!string.IsNullOrWhiteSpace(qPageSize)) { <input type="hidden" name="PageSize" value="@qPageSize" /> }
        <input type="hidden" name="PageNumber" value="1" />
      </div>
    </form>
  </div>

  <!-- Saƒü: Fiyat filtresi a√ß/kapa -->
  <div class="col-12 col-md-auto order-3 text-md-end">
    <button class="btn btn-sm btn-outline-navy rounded-pill px-3 w-100 w-md-auto"
            type="button" data-bs-toggle="collapse" data-bs-target="#priceFilter"
            aria-expanded="false" aria-controls="priceFilter">
      <i class="fa fa-filter me-1"></i> Fiyat
    </button>
  </div>
</div>

<!-- üîΩ Fiyat filtresi (collapse) -->
<div class="collapse" id="priceFilter">
  <div class="card card-body shadow-sm border-0 mb-3">
    <form id="priceForm" method="get"
          asp-area="Admin" asp-controller="Product" asp-action="Index"
          class="row g-2 align-items-end needs-validation" novalidate>

      @if (activeId.HasValue) { <input type="hidden" name="CategoryId" value="@activeId.Value" /> }
      @if (!string.IsNullOrWhiteSpace(qSearch)) { <input type="hidden" name="SearchTerm" value="@qSearch" /> }
      @if (!string.IsNullOrWhiteSpace(qPageSize)) { <input type="hidden" name="PageSize" value="@qPageSize" /> }
      <input type="hidden" name="PageNumber" value="1" />

      <div class="col-6 col-sm-3">
        <label class="form-label small text-muted mb-1">Min</label>
        <div class="input-group">
          <span class="input-group-text">‚Ç∫</span>
          <input type="number" min="0" step="1" class="form-control" name="MinPrice"
                 value="@(string.IsNullOrWhiteSpace(qMin) ? "" : qMin)" placeholder="0" />
        </div>
        <div class="invalid-feedback">L√ºtfen ge√ßerli bir minimum fiyat girin.</div>
      </div>

      <div class="col-6 col-sm-3">
        <label class="form-label small text-muted mb-1">Max</label>
        <div class="input-group">
          <span class="input-group-text">‚Ç∫</span>
          <input type="number" min="0" step="1" class="form-control" name="MaxPrice"
                 value="@(string.IsNullOrWhiteSpace(qMax) ? "" : qMax)" placeholder="99999" />
        </div>
        <div class="invalid-feedback">Maksimum fiyat, minimumdan k√º√ß√ºk olamaz.</div>
      </div>

      <div class="col-12 col-sm-auto">
        <button type="submit" class="btn btn-navy w-100">Uygula</button>
      </div>

      <div class="col-12 col-sm-auto">
        <a class="btn btn-outline-secondary w-100"
           asp-area="Admin" asp-controller="Product" asp-action="Index"
           asp-route-CategoryId="@(activeId)"
           asp-route-SearchTerm="@(qSearch)">
          Temizle
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Saƒü √ºstte "Yeni √úr√ºn" butonu -->
<div class="d-flex justify-content-end mb-3">
    <a class="btn btn-outline-success tooltip1-btn-admin-add" asp-area="Admin" asp-action="Create">
        <i class="fa fa-plus"></i>
    </a>
</div>

<!-- ‚úÖ √úR√úN TABLOSU -->
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
      <thead>
          <tr>
              <th>Id</th>
              <th>Fotoƒüraf</th>
              <th>√úr√ºn Adƒ±</th>
              <th>Vitrin</th>
              <th>Fiyat</th>
              <th class="text-center">ƒ∞≈ülemler</th>
          </tr>
      </thead>
      <tbody>
      @foreach (var prd in Model.Products)
      {
          <tr>
              <td>@prd.ProductId</td>
              <td>
                  <img src="@prd?.ImageUrl" alt="@prd?.ProductName" width="50" class="rounded">
              </td>
              <td>@prd.ProductName</td>
              <td>
                  <div class="form-check form-switch">
                      <input type="checkbox" class="form-check-input" checked="@prd.ShowCase" disabled />
                  </div>
              </td>
              <td>@prd.Price.ToString("c")</td>
              <td class="text-center">
                  <div class="d-inline-flex flex-nowrap gap-2 actions">
                      <a class="btn btn-warning tooltip1-btn-admin-edit"
                         asp-area="Admin" asp-action="Update" asp-route-id="@prd.ProductId" title="D√ºzenle">
                          <i class="fa fa-edit"></i>
                      </a>

                      <a class="btn btn-primary tooltip1-btn-admin-detail" target="_blank"
                         asp-area="" asp-controller="Product" asp-action="Get" asp-route-id="@prd.ProductId" title="Detay">
                          <i class="fa fa-search"></i>
                      </a>

                      <form asp-area="Admin" asp-action="Delete" asp-route-id="@prd.ProductId"
                            method="post" class="d-inline delete-form tooltip1-btn-admin-delete" title="Sil">
                          @Html.AntiForgeryToken()
                          <button type="submit" class="btn btn-danger">
                              <i class="fa fa-trash"></i>
                          </button>
                      </form>
                  </div>
              </td>
          </tr>
      }
      </tbody>
  </table>
</div>

<!-- ‚úÖ PAGER -->
<div class="text-center my-3">
  <div
    page-model="@Model.Pagination"
    page-action="Index"
    page-classes-enabled="true"
    page-class="btn"
    page-class-normal="btn-outline-primary"
    page-class-selected="btn-warning"
    class="btn-group"
    page-url-area="Admin"
    page-url-CategoryId="@(activeId)"
    page-url-SearchTerm="@(qSearch)"
    page-url-MinPrice="@(qMin)"
    page-url-MaxPrice="@(qMax)"
    page-url-PageSize="@Model.Pagination.ItemsPerPage">
  </div>
</div>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Silme onayƒ±
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".delete-form").forEach(function (form) {
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          Swal.fire({
            title: 'Emin misiniz?',
            text: "Bu √ºr√ºn√º silmek √ºzeresiniz!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, sil',
            cancelButtonText: 'Vazge√ß',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
          }).then((result) => { if (result.isConfirmed) form.submit(); });
        });
      });
    });
  </script>

  <script>
    // Min ‚â§ Max doƒürulamasƒ±
    (function () {
      const form = document.getElementById('priceForm');
      if (!form) return;
      const minEl = form.querySelector('input[name="MinPrice"]');
      const maxEl = form.querySelector('input[name="MaxPrice"]');
      function validate() {
        const min = parseFloat(minEl.value);
        const max = parseFloat(maxEl.value);
        const bothNumbers = !Number.isNaN(min) && !Number.isNaN(max);
        if (bothNumbers && min > max) {
          maxEl.setCustomValidity('Maksimum fiyat, minimumdan k√º√ß√ºk olamaz.');
          maxEl.classList.add('is-invalid');
          return false;
        } else {
          maxEl.setCustomValidity('');
          maxEl.classList.remove('is-invalid');
          return true;
        }
      }
      minEl.addEventListener('input', validate);
      maxEl.addEventListener('input', validate);
      form.addEventListener('submit', function (e) {
        if (!validate()) {
          e.preventDefault(); e.stopPropagation();
          form.classList.add('was-validated'); maxEl.focus();
        }
      }, false);
    })();
  </script>
}
