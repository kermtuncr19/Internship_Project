<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="header-sticky">

  <!-- ðŸ”µ PROMO ÅžERÄ°DÄ° (NAVBAR ÃœSTÃœ) -->
  <div class="promo-strip" role="region" aria-label="Kampanya duyurularÄ±">
    <div class="container-fluid d-flex justify-content-center align-items-center gap-2">
      <div class="promo-viewport" aria-live="polite">
        <span class="promo-msg active">
          <i class="fa-solid fa-bullhorn"></i>
          2000 TL ve Ã¼zeri alÄ±ÅŸveriÅŸlerde kargo bedava! ðŸšš
        </span>
        <span class="promo-msg">
          <i class="fa-solid fa-bullhorn"></i>
          2000 TL ve Ã¼zeri alÄ±ÅŸveriÅŸlerde peÅŸin fiyatÄ±na 3 taksit! ðŸ’³
        </span>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const msgs = document.querySelectorAll(".promo-viewport .promo-msg");
      if (!msgs || msgs.length <= 1) return;

      let i = 0;
      msgs.forEach((m, idx) => m.classList.toggle("active", idx === 0));

      setInterval(() => {
        msgs[i].classList.remove("active");
        i = (i + 1) % msgs.length;
        msgs[i].classList.add("active");
      }, 4000);
    });
  </script>

  <!-- ðŸŸ¡ NAVBAR -->
  <nav class="navbar navbar-expand-lg border-bottom main-navbar" style="background-color:#ffea00; border:none;"
       data-bs-theme="light">
    <div class="container-fluid">

      <!-- LOGO -->
      <a class="navbar-brand d-flex align-items-center me-2" asp-controller="Home" asp-action="Index">
        <img src="~/images/fenerium-logo.png" asp-append-version="true" alt="Fenerium"
             class="d-inline-block align-text-top" style="height:28px;width:auto;object-fit:contain;" />
      </a>

      <!-- Toggler -->
      <button id="navCompactBtn" class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Ä°Ã§erik -->
      <div class="collapse navbar-collapse" id="mainNav">

        <!-- âœ… Mobilde saklanacak her ÅŸey -->
        <div class="nav-hide-on-compact w-100 d-flex flex-column flex-lg-row align-items-lg-center">
          <div class="nav-row">

            <!-- ORTA: SEARCH -->
            <form class="navbar-search order-2 order-lg-1 my-2 my-lg-0 mx-lg-3 flex-grow-1" method="get"
                  asp-controller="Product" asp-action="Index" role="search">
              <div class="input-group nav-search w-100">
                <span class="input-group-text border-end-0"><i class="fa fa-search"></i></span>
                <input type="search" class="form-control border-start-0" name="SearchTerm"
                       value="@(Context.Request.Query["SearchTerm"])" placeholder="Fenerium'da Ara" aria-label="Ara" />
                <button class="btn btn-navy d-none d-md-inline-flex" type="submit">Ara</button>

                @if (int.TryParse(Context.Request.Query["CategoryId"], out var cid))
                {
                  <input type="hidden" name="CategoryId" value="@cid" />
                }
              </div>
            </form>

            <!-- SAÄž: SEPET + GÄ°RÄ°Åž / PROFÄ°L -->
            <ul class="navbar-nav ms-lg-auto align-items-center gap-2 order-1 order-lg-3 actions">

              <!-- Sepet -->
              <li class="nav-item p-0 m-0">
                @await Component.InvokeAsync("CartSummary")
              </li>

              @if (User.Identity?.IsAuthenticated ?? false)
              {
                var avatarUrl = ViewBag.UserAvatarUrl as string ?? "/images/avatar-placeholder.png";
                var userName = ViewBag.UserFullName as string ?? User.Identity.Name ?? "KullanÄ±cÄ±";

                <!-- KullanÄ±cÄ± Dropdown -->
                <li class="nav-item dropdown user-dropdown-hover">
                  <a class="nav-link d-flex align-items-center gap-2" href="#" id="userMenu" role="button"
                     aria-expanded="false">
                    <img src="@avatarUrl" alt="@userName" class="user-avatar" />
                    <span class="d-none d-lg-inline text-navy fw-semibold">@userName</span>
                  </a>

                  <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userMenu">
                    <li class="dropdown-header">
                      <div class="d-flex align-items-center gap-2">
                        <img src="@avatarUrl" alt="@userName" class="rounded-circle"
                             style="width:40px;height:40px;object-fit:cover;" />
                        <div>
                          <div class="fw-semibold">@userName</div>
                          <div class="small text-muted">@User.Identity.Name</div>
                        </div>
                      </div>
                    </li>

                    <li><hr class="dropdown-divider" /></li>

                    <li>
                      <a class="dropdown-item" asp-controller="Profile" asp-action="Index">
                        <i class="fa fa-user me-2 text-navy"></i> HesabÄ±m
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" asp-controller="MyOrders" asp-action="Index">
                        <i class="fa fa-box me-2 text-navy"></i> SipariÅŸlerim
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" asp-controller="Favorites" asp-action="Index">
                        <i class="fa fa-heart me-2 text-navy"></i> Favorilerim
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" asp-controller="Addresses" asp-action="Index">
                        <i class="fa fa-location-dot me-2 text-navy"></i> Adreslerim
                      </a>
                    </li>

                    @if (User.IsInRole("Admin"))
                    {
                      <li><hr class="dropdown-divider" /></li>
                      <li>
                        <a class="dropdown-item" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
                          <i class="fa-solid fa-screwdriver-wrench me-2 text-secondary"></i> Admin Paneli
                        </a>
                      </li>
                    }

                    <li><hr class="dropdown-divider" /></li>

                    <li class="px-3">
                      <form asp-controller="Account" asp-action="Logout" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="dropdown-item text-danger p-0">
                          <i class="fa-solid fa-right-from-bracket me-2"></i> Ã‡Ä±kÄ±ÅŸ Yap
                        </button>
                      </form>
                    </li>
                  </ul>
                </li>
              }
              else
              {
                <partial name="_LoginMenu" />
              }
            </ul>
          </div>

        </div> <!-- nav-hide-on-compact -->

      </div>
    </div>
  </nav>

  <!-- ðŸ§­ CATEGORY STRIP -->
  @if (ViewBag.Categories is IEnumerable<Entities.Models.Category> cats)
  {
    var activeId = ViewBag.ActiveCategoryId as int?;
    var ctrl = (ViewContext.RouteData.Values["controller"] as string) ?? "";
    var act = (ViewContext.RouteData.Values["action"] as string) ?? "";
    bool showBar = ctrl == "Home" || ctrl == "Product";

    if (showBar)
    {
      <div class="category-strip">
        <div class="container-fluid py-2">

          <!-- âœ… MOBÄ°L: Dropdown Toggle -->
          <button class="btn cat-dd-toggle d-md-none w-100" type="button" data-bs-toggle="collapse"
                  data-bs-target="#mobileCategoryMenu" aria-expanded="false" aria-controls="mobileCategoryMenu">
            <span class="d-flex align-items-center justify-content-between">
              <span><i class="fa-solid fa-list me-2"></i>Kategoriler</span>
              <i class="fa-solid fa-chevron-down dd-chevron"></i>
            </span>
          </button>

          <!-- âœ… MOBÄ°L: Dropdown MenÃ¼ -->
          <div class="collapse cat-dd-collapse d-md-none mt-2" id="mobileCategoryMenu">
            <div class="cat-dd-panel">
              <a asp-controller="Product" asp-action="Index" class="cat-dd-item @(activeId == null ? "active" : "")">
                <i class="fa-solid fa-store"></i> TÃ¼m ÃœrÃ¼nler
              </a>

              @foreach (var c in cats)
              {
                string icon = c.CategoryName switch
                {
                  "Futbol" => "fa-solid fa-futbol",
                  "Basketbol" => "fa-solid fa-basketball",
                  "Voleybol" => "fa-solid fa-volleyball",
                  _ => "fa-solid fa-tag"
                };

                <a asp-controller="Product" asp-action="Index" asp-route-categoryId="@c.CategoryId"
                   class="cat-dd-item @(activeId == c.CategoryId ? "active" : "")">
                  <i class="@icon"></i> @c.CategoryName
                </a>
              }
            </div>
          </div>

          <!-- âœ… DESKTOP: Yatay ÅŸerit -->
          <div class="d-none d-md-flex gap-3 overflow-auto">
            <a asp-controller="Product" asp-action="Index" class="category-item @(activeId == null ? "active-cat" : "")">
              <i class="fa-solid fa-store"></i> TÃ¼m ÃœrÃ¼nler
            </a>

            @foreach (var c in cats)
            {
              string icon = c.CategoryName switch
              {
                "Futbol" => "fa-solid fa-futbol",
                "Basketbol" => "fa-solid fa-basketball",
                "Voleybol" => "fa-solid fa-volleyball",
                _ => "fa-solid fa-tag"
              };

              <a asp-controller="Product" asp-action="Index" asp-route-categoryId="@c.CategoryId"
                 class="category-item @(activeId == c.CategoryId ? "active-cat" : "")">
                <i class="@icon"></i> @c.CategoryName
              </a>
            }
          </div>

        </div>
      </div>
    }
  }

</div> <!-- header-sticky end -->

<div id="header-spacer"></div>

<script>
  function syncHeaderSpacer() {
    const header = document.querySelector('.header-sticky');
    const spacer = document.getElementById('header-spacer');
    if (!header || !spacer) return;
    spacer.style.height = header.offsetHeight + "px";
  }

  window.addEventListener("load", syncHeaderSpacer);
  window.addEventListener("resize", syncHeaderSpacer);
</script>

<!-- âœ… Compact Toggle Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("navCompactBtn");
    const nav = document.querySelector(".main-navbar");

    if (!btn || !nav) return;

    btn.addEventListener("click", function () {
      if (window.innerWidth <= 991) {
        nav.classList.toggle("is-compact");
      }
    });

    window.addEventListener("resize", function () {
      if (window.innerWidth > 991) {
        nav.classList.remove("is-compact");
      }
    });
  });
</script>

<!-- âœ… USER DROPDOWN (mobilde navbar altÄ±na sabitle) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {

    const toggle = document.getElementById("userMenu");
    const li = toggle?.closest(".user-dropdown-hover");
    const menu = li?.querySelector(".dropdown-menu");
    const yellowNav = document.querySelector(".main-navbar");

    if (!toggle || !li || !menu) return;

    // âœ… Bootstrap/Popper inline stillerini her seferinde temizle
    function hardResetMenuStyles() {
      menu.style.removeProperty("top");
      menu.style.removeProperty("right");
      menu.style.removeProperty("left");
      menu.style.removeProperty("transform");
      menu.style.removeProperty("inset");

      menu.removeAttribute("data-popper-placement");
    }

    function positionMenuMobile() {
      if (window.innerWidth > 991) return;

      const gap = 6;
      const navRect = yellowNav?.getBoundingClientRect();
      const top = (navRect ? navRect.bottom : 0) + gap;

      const toggleRect = toggle.getBoundingClientRect();
      const right = Math.max(12, window.innerWidth - toggleRect.right);

      // âœ… CSS deÄŸiÅŸkeniyle ver -> CSS'teki !important her ÅŸeyi ezer
      menu.style.setProperty("--ud-top", top + "px");
      menu.style.setProperty("--ud-right", right + "px");

      // taÅŸma olmasÄ±n
      const maxH = Math.max(180, window.innerHeight - top - 12);
      menu.style.maxHeight = maxH + "px";
      menu.style.overflowY = "auto";
    }

    function openMenu() {
      li.classList.add("show");
      menu.classList.add("show");
      toggle.setAttribute("aria-expanded", "true");

      hardResetMenuStyles();

      // âœ… layout otursun diye bir frame sonra konumla
      requestAnimationFrame(() => positionMenuMobile());
    }

    function closeMenu() {
      li.classList.remove("show");
      menu.classList.remove("show");
      toggle.setAttribute("aria-expanded", "false");
    }

    function toggleMenu() {
      const isOpen = menu.classList.contains("show");
      isOpen ? closeMenu() : openMenu();
    }

    // âœ… TÄ±klayÄ±nca aÃ§/kapa
    toggle.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      toggleMenu();
    });

    // âœ… MenÃ¼ iÃ§indeki tÄ±klamalar dÄ±ÅŸ click'e gitmesin
    menu.addEventListener("click", function (e) {
      e.stopPropagation();
    });

    // âœ… DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
    document.addEventListener("click", function (e) {
      if (!li.contains(e.target)) closeMenu();
    });

    // âœ… ESC ile kapat
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeMenu();
    });

    // âœ… Desktop hover (istersen)
    function bindHover() {
      li.addEventListener("mouseenter", openMenu);
      li.addEventListener("mouseleave", closeMenu);
    }
    function unbindHover() {
      li.removeEventListener("mouseenter", openMenu);
      li.removeEventListener("mouseleave", closeMenu);
    }

    function applyMode() {
      if (window.innerWidth > 991) {
        bindHover();
      } else {
        unbindHover();
        closeMenu();
      }
    }

    window.addEventListener("resize", applyMode);
    applyMode();

    window.addEventListener("scroll", () => {
      if (menu.classList.contains("show")) positionMenuMobile();
    }, { passive: true });

    window.addEventListener("resize", () => {
      if (menu.classList.contains("show")) positionMenuMobile();
    });
  });
</script>

