@model Product
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="col-sm-6 col-md-4 col-lg-3 col-xl-2-4 my-3">
  <div class="card h-100 product-card position-relative hover-card">
    <a asp-controller="Product" asp-action="Get" asp-route-id="@Model.ProductId" class="card-img-link" aria-label="@Model.ProductName">
      <div class="img-box" style="height:250px; padding:15px; background-color:#f8f9fa; display:flex; align-items:center; justify-content:center;">
        <img src="@Model?.ImageUrl" class="img-fluid" alt="@Model?.ProductName" style="max-height:100%; max-width:100%; object-fit:contain;">
      </div>
    </a>
    <div class="card-body d-flex flex-column p-3">
      <div class="text-navy text-center lead rounded-2 mb-2">
        @Model.Price.ToString("c")
      </div>
      <h5 class="card-title" style="font-size:0.95rem; min-height:2.5rem;">@Model.ProductName</h5>
      
  @{
    var ratings = ViewBag.Ratings as Dictionary<int, (int count, double avg)> ?? 
                  new Dictionary<int, (int, double)>();
    var has = ratings.TryGetValue(Model.ProductId, out var rdata);
    var reviewCount = has ? rdata.count : 0;
    var avgRating = has ? rdata.avg : 0.0;
}
<div class="d-flex align-items-center gap-1 mb-2">
    @for (int i = 1; i <= 5; i++)
    {
        if (i <= Math.Floor(avgRating))
        {
            <i class="fa-solid fa-star" style="color:#ffc107; font-size:0.95rem;"></i>
        }
        else if (i == (int)Math.Floor(avgRating) + 1 && (avgRating - Math.Floor(avgRating)) >= 0.25 && (avgRating - Math.Floor(avgRating)) < 0.75)
        {
            <i class="fa-solid fa-star-half-stroke" style="color:#ffc107; font-size:0.95rem;"></i>
        }
        else
        {
            <i class="fa-regular fa-star" style="color:#ddd; font-size:0.95rem;"></i>
        }
    }
    <span class="text-muted small ms-2">@avgRating.ToString("0.0") (@reviewCount)</span>
</div>

      <div class="mt-auto d-flex align-items-center justify-content-between">
        <a asp-controller="Product" asp-action="Get" asp-route-id="@Model.ProductId" class="btn btn-sm me-2 tooltip1-btn" style="background-color:#ffea00; color:black; border:none;">
          <i class="fa-solid fa-arrow-right"></i>
        </a>
        <div class="d-flex align-items-center gap-2">
          @if (User.Identity?.IsAuthenticated == true)
          {
            var favoriteIds = ViewBag.FavoriteIds as List<int> ?? new List<int>();
            var isFavorite = favoriteIds.Contains(Model.ProductId);
            <button type="button" class="btn p-0 border-0 bg-transparent js-fav-btn" data-product-id="@Model.ProductId" aria-pressed="@(isFavorite.ToString().ToLower())" style="line-height:1; position:relative; z-index:2;">
              <i class="fav-icon @(isFavorite ? "fa-solid" : "fa-regular") fa-heart fa-lg" style="@(isFavorite ? "color:#dc3545;" : "color:#0d1b4c;") cursor:pointer; transition:color .2s;"></i>
            </button>
          }
          @if (Model.RequiresSize)
          {
            <a asp-controller="Product" asp-action="Get" asp-route-id="@Model.ProductId" class="btn btn-primary btn-sm tooltip-btn" style="border:none;" title="Beden seçmek için detay sayfasına geçin">
              <i class="fa fa-cart-plus"></i>
            </a>
          }
          else
          {
            <form id="@Model.ProductId" asp-page="/cart" method="post" class="m-0">
              @Html.AntiForgeryToken()
              <input type="hidden" asp-for="ProductId" />
              <input type="hidden" name="returnUrl" value="@ViewContext.HttpContext.Request.PathAndQuery()" />
              <button type="submit" class="btn btn-primary btn-sm tooltip-btn" style="border:none;">
                <i class="fa fa-cart-plus"></i>
              </button>
            </form>
          }
        </div>
      </div>
    </div>
  </div>
</div>