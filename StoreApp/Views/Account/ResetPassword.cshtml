@model Entities.Dto.ResetPasswordDto

<link rel="stylesheet" href="~/css/login.css" asp-append-version="true" />
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <i class="fa-solid fa-key" style="font-size: 3rem; color: #001f54;"></i>
        </div>
        <h2 class="login-title">Yeni Şifre Oluştur</h2>
        <p class="text-center text-muted mb-4">
            Hesabınız için yeni bir şifre belirleyin.
        </p>

        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.ErrorCount > 0)
        {
            <div class="alert alert-danger">
                <div asp-validation-summary="All"></div>
            </div>
        }

        <form method="post" asp-action="ResetPassword" id="resetPasswordForm">
            @Html.AntiForgeryToken()
            <!-- Email ve Token'ı hidden field olarak gönder -->
            <input type="hidden" name="Email" value="@ViewBag.Email" />
            <input type="hidden" name="Token" value="@ViewBag.Token" />

            <div class="form-group">
                <label asp-for="Password" class="form-label">
                    <i class="fa-solid fa-lock"></i> Yeni Şifre
                </label>
                <div class="password-wrapper">
                    <input type="password" asp-for="Password" class="form-input" 
                           id="Password" placeholder="Yeni şifrenizi girin"
                           autocomplete="new-password" />
                    <span class="password-toggle" onclick="togglePasswordField('Password')">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>
                <span class="text-danger" asp-validation-for="Password"></span>
            </div>

            <div class="form-group">
                <label asp-for="ConfirmPassword" class="form-label">
                    <i class="fa-solid fa-lock"></i> Şifre Tekrar
                </label>
                <div class="password-wrapper">
                    <input type="password" asp-for="ConfirmPassword" class="form-input"
                           id="ConfirmPassword" placeholder="Şifrenizi tekrar girin" 
                           autocomplete="new-password" />
                    <span class="password-toggle" onclick="togglePasswordField('ConfirmPassword')">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>
                <span class="text-danger" asp-validation-for="ConfirmPassword"></span>
            </div>

            <!-- Gerçek Zamanlı Şifre Kuralları Kontrolü -->
            <div class="alert alert-info" style="font-size: 0.85rem;" id="passwordRules">
                <i class="fa-solid fa-info-circle"></i>
                <strong>Şifre Kuralları:</strong><br>
                <span id="rule-length" class="rule-item">
                    <i class="fa-solid fa-circle"></i> En az 8 karakter
                </span><br>
                <span id="rule-lowercase" class="rule-item">
                    <i class="fa-solid fa-circle"></i> En az bir küçük harf
                </span><br>
                <span id="rule-uppercase" class="rule-item">
                    <i class="fa-solid fa-circle"></i> En az bir büyük harf
                </span><br>
                <span id="rule-number" class="rule-item">
                    <i class="fa-solid fa-circle"></i> En az bir rakam
                </span><br>
                <span id="rule-space" class="rule-item">
                    <i class="fa-solid fa-circle"></i> Boşluk içeremez
                </span>
            </div>

            <button type="submit" class="btn-login" id="submitBtn">
                <i class="fa-solid fa-check"></i> Şifreyi Güncelle
            </button>
        </form>

        <div class="register-link">
            <a asp-action="Login">
                <i class="fa-solid fa-arrow-left"></i> Giriş Sayfasına Dön
            </a>
        </div>
    </div>
</div>

<style>
    .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        cursor: pointer;
        color: #666;
        user-select: none;
        z-index: 10;
    }

    .password-toggle:hover {
        color: #001f54;
    }

    .rule-item {
        display: block;
        transition: all 0.3s ease;
    }

    .rule-item.valid {
        color: #28a745;
    }

    .rule-item.valid i {
        color: #28a745;
    }

    .rule-item.invalid {
        color: #dc3545;
    }

    .rule-item.invalid i {
        color: #dc3545;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        console.log('Script yüklendi');

        // Şifre göster/gizle
        function togglePasswordField(inputId) {
            console.log('Toggle çağrıldı:', inputId);
            const input = document.getElementById(inputId);
            
            if (!input) {
                console.error('Input bulunamadı:', inputId);
                return;
            }

            const wrapper = input.closest('.password-wrapper');
            if (!wrapper) {
                console.error('Wrapper bulunamadı');
                return;
            }

            const toggleSpan = wrapper.querySelector('.password-toggle');
            const icon = toggleSpan?.querySelector('i');

            if (!icon) {
                console.error('Icon bulunamadı');
                return;
            }

            // Type değiştir
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Gerçek zamanlı şifre validasyonu
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('Password');
            const confirmInput = document.getElementById('ConfirmPassword');

            if (!passwordInput) {
                console.error('Password input bulunamadı!');
                return;
            }

            console.log('Event listener eklendi');

            passwordInput.addEventListener('input', function() {
                validatePassword(this.value);
            });

            function validatePassword(password) {
                // Kuralları kontrol et
                const hasLength = password.length >= 8;
                const hasLowercase = /[a-zğüşıöç]/.test(password);
                const hasUppercase = /[A-ZĞÜŞİÖÇ]/.test(password);
                const hasNumber = /\d/.test(password);
                const noSpace = !/\s/.test(password);

                // UI'ı güncelle
                updateRule('rule-length', hasLength);
                updateRule('rule-lowercase', hasLowercase);
                updateRule('rule-uppercase', hasUppercase);
                updateRule('rule-number', hasNumber);
                updateRule('rule-space', noSpace);

                console.log('Validasyon:', {
                    hasLength, hasLowercase, hasUppercase, hasNumber, noSpace
                });
            }

            function updateRule(ruleId, isValid) {
                const ruleElement = document.getElementById(ruleId);
                if (!ruleElement) return;

                const icon = ruleElement.querySelector('i');
                
                if (isValid) {
                    ruleElement.classList.remove('invalid');
                    ruleElement.classList.add('valid');
                    if (icon) {
                        icon.classList.remove('fa-circle');
                        icon.classList.add('fa-circle-check');
                    }
                } else {
                    ruleElement.classList.remove('valid');
                    ruleElement.classList.add('invalid');
                    if (icon) {
                        icon.classList.remove('fa-circle-check');
                        icon.classList.add('fa-circle');
                    }
                }
            }

            // Form submit debug
            const form = document.getElementById('resetPasswordForm');
            form.addEventListener('submit', function(e) {
                console.log('Form submit edildi');
                console.log('Email:', document.querySelector('[name="Email"]')?.value);
                console.log('Token:', document.querySelector('[name="Token"]')?.value);
                console.log('Password:', passwordInput?.value);
                console.log('ConfirmPassword:', confirmInput?.value);
            });
        });
    </script>
}