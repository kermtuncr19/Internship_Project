@model ProductListViewModel
@using Entities.Models

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

@{
    var activeId = ViewBag.ActiveCategoryId as int?;
    var cats = ViewBag.Categories as IEnumerable<Category>;

    // Mevcut deÄŸerleri QueryString'den okuyup input'lara set edelim
    var qMin = Context.Request.Query["MinPrice"].ToString();
    var qMax = Context.Request.Query["MaxPrice"].ToString();
    var qSearch = Context.Request.Query["SearchTerm"].ToString();
    var qSort = Context.Request.Query["SortBy"].ToString();
}

@* âœ… ARAMA BÄ°LGÄ° BANNERI (Sadece SearchTerm varsa gÃ¶ster) *@
@if (!string.IsNullOrEmpty(ViewBag.SearchInfo) && !string.IsNullOrEmpty(qSearch))
{
    <div class="alert alert-info d-flex align-items-center justify-content-between mb-3 mt-3 shadow-sm"
         style="border-left: 4px solid #001f5c; border-radius: 8px;">
        <div class="d-flex align-items-center gap-2">
            <i class="fa fa-info-circle fs-5"></i>
            <div>
                <strong class="d-block">@ViewBag.SearchInfo</strong>
                <small class="text-muted">@Model.Pagination.TotalItems Ã¼rÃ¼n bulundu</small>
            </div>
        </div>
        <a asp-action="Index" class="btn btn-sm btn-outline-secondary rounded-pill">
            <i class="fa fa-times me-1"></i> Temizle
        </a>
    </div>
}

@if (TempData["PriceError"] is string pe && !string.IsNullOrWhiteSpace(pe))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @pe
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- âœ… KATEGORÄ° ÅžERÄ°DÄ° + FÄ°LTRE (responsive) -->
<div class="category-bar row g-2 align-items-center mb-3 mt-4">
    <!-- Fiyat dÃ¼ÄŸmesi: xs'de altta full-width, md+'da saÄŸda -->
    <div class="col-12 col-md-auto text-start">
        <button class="filter-chip" type="button"   data-bs-toggle="collapse" data-bs-target="#priceFilter"
                aria-expanded="false" aria-controls="priceFilter">
            <i class="fa fa-sliders"></i>
            <span>Filtre</span>
        </button>
    </div>

</div>

<!-- ðŸ”½ AÃ‡ILIR FÄ°YAT FÄ°LTRESÄ° (collapse) -->
<div class="collapse" id="priceFilter" style="position: relative; z-index: 1030;">
    <div class="card card-body shadow-sm border-0 mb-3">
        <form id="priceForm" method="get" asp-controller="Product" asp-action="Index"
              class="row g-2 align-items-end needs-validation" novalidate>

            @* aktif kategori + arama terimi + sayfalama korunur *@
            @if (activeId.HasValue)
            {
                <input type="hidden" name="CategoryId" value="@activeId.Value" />
            }
            @if (!string.IsNullOrWhiteSpace(qSearch))
            {
                <input type="hidden" name="SearchTerm" value="@qSearch" />
            }
            <input type="hidden" name="PageNumber" value="1" />
            <input type="hidden" name="PageSize" value="@Model.Pagination.ItemsPerPage" />

            <div class="col-6 col-sm-3">
                <label class="form-label small text-muted mb-1">Min</label>
                <div class="input-group">
                    <span class="input-group-text">â‚º</span>
                    <input type="number" min="0" step="1" class="form-control" name="MinPrice"
                           value="@(string.IsNullOrWhiteSpace(qMin) ? "" : qMin)" placeholder="0" />
                </div>
                <div class="invalid-feedback">LÃ¼tfen geÃ§erli bir minimum fiyat girin.</div>
            </div>

            <div class="col-6 col-sm-3">
                <label class="form-label small text-muted mb-1">Max</label>
                <div class="input-group">
                    <span class="input-group-text">â‚º</span>
                    <input type="number" min="0" step="1" class="form-control" name="MaxPrice"
                           value="@(string.IsNullOrWhiteSpace(qMax) ? "" : qMax)" placeholder="99999" />
                </div>
                <div class="invalid-feedback">Maksimum fiyat, minimumdan kÃ¼Ã§Ã¼k olamaz.</div>
            </div>

            <!-- âœ… Ã–zel SIRALAMA DROPDOWN -->
            <div class="col-12 col-md-3">
                <label class="form-label small text-muted mb-1">SÄ±rala</label>

                <!-- Gizli input: form gerÃ§ek deÄŸeri buradan alacak -->
                <input type="hidden" name="SortBy" id="sortByHidden" value="@qSort" />

                <div class="dropdown">
                    <button class="btn sort-dropdown-btn w-100 dropdown-toggle" type="button"                   id="sortDropdownBtn"
                            data-bs-toggle="dropdown" aria-expanded="false"                        style="position: relative; z-index: 1040;">
                        @{
                            var label = qSort switch
                            {
                                "price_asc" => "Fiyat (DÃ¼ÅŸÃ¼kten YÃ¼kseÄŸe)",
                                "price_desc" => "Fiyat (YÃ¼ksekten DÃ¼ÅŸÃ¼ÄŸe)",
                                "reviews_desc" => "En Ã‡ok DeÄŸerlendirilenler",
                                "rating_desc" => "En YÃ¼ksek PuanlÄ±",
                                "rating_asc" => "En DÃ¼ÅŸÃ¼k PuanlÄ±",
                                _ => "VarsayÄ±lan"
                            };
                        }
                        @label
                    </button>

                    <ul class="dropdown-menu shadow sort-dropdown-menu" aria-labelledby="sortDropdownBtn"
                        style="z-index: 1050;">
                        <li><button type="button" class="dropdown-item sort-option" data-value="">VarsayÄ±lan</button>
                        </li>
                        <li><button type="button" class="dropdown-item sort-option" data-value="price_asc">Fiyat
                            (DÃ¼ÅŸÃ¼kten YÃ¼kseÄŸe)</button></li>
                            <li><button type="button" class="dropdown-item sort-option" data-value="price_desc">Fiyat
                                (YÃ¼ksekten DÃ¼ÅŸÃ¼ÄŸe)</button></li>
                                <li><button type="button" class="dropdown-item sort-option" data-value="reviews_desc">En Ã‡ok
                                    DeÄŸerlendirilenler</button></li>
                                    <li><button type="button" class="dropdown-item sort-option" data-value="rating_desc">En YÃ¼ksek
                                        PuanlÄ±</button></li>
                                        <li><button type="button" class="dropdown-item sort-option" data-value="rating_asc">En DÃ¼ÅŸÃ¼k
                                            PuanlÄ±</button></li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="col-12 col-md-auto">
                                    <button type="submit" class="btn btn-navy w-100">Uygula</button>
                                </div>

                                <div class="col-12 col-md-auto">
                                    <a class="btn btn-outline-secondary w-100" asp-controller="Product" asp-action="Index"
                                           asp-route-CategoryId="@(activeId)" asp-route-SearchTerm="@(qSearch)">
                                        Temizle
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- âœ… ÃœRÃœN KARTLARI -->
                    <div>
                        @if (Model.Products.Any())
                        {
                            <div id="productGrid" class="row my-3">
                                @foreach (var prd in Model.Products)
                                {
                                    <partial name="_ProductCard" model="prd" />
                                }
                            </div>

                            <div class="d-flex justify-content-center my-4 loadmore-wrap">
    @if (Model.Pagination.CurrentPage < Model.Pagination.TotalPage)
    {
        <button id="btnLoadMore"
                class="btn btn-navy px-4 rounded-pill loadmore-btn"
                data-next-page="@(Model.Pagination.CurrentPage + 1)">
            Daha fazla yÃ¼kle...
        </button>
    }
    else
    {
        <div class="loadmore-done rounded-pill px-4 py-2">
            TÃ¼mÃ¼ yÃ¼klendi!
        </div>
    }
</div>


                        }
                        else
                        {
                            @* âœ… ÃœRÃœN BULUNAMADI EKRANI *@
                            <div class="card shadow-sm border-0 my-4">
                                <div class="card-body text-center py-5">
                                    <i class="fa fa-search fa-4x text-muted mb-3 opacity-50"></i>
                                    <h5 class="text-muted mb-2">AradÄ±ÄŸÄ±nÄ±z kriterlere uygun Ã¼rÃ¼n bulunamadÄ±</h5>
                                    <p class="text-muted mb-4">FarklÄ± bir arama terimi veya filtre deneyin</p>
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <a asp-action="Index" class="btn btn-navy rounded-pill px-4">
                                            <i class="fa fa-store me-2"></i> TÃ¼m ÃœrÃ¼nler
                                        </a>
                                        @if (!string.IsNullOrWhiteSpace(qSearch))
                                        {
                                            <a asp-action="Index" asp-route-CategoryId="@activeId"
                                                   class="btn btn-outline-secondary rounded-pill px-4">
                                                <i class="fa fa-times me-2"></i> AramayÄ± Temizle
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @section Scripts {
                        <script>
                                // Min â‰¤ Max doÄŸrulamasÄ± (JS tarafÄ±)
                                (function () {
                                    const form = document.getElementById('priceForm');
                                    if (!form) return;
                                    const minEl = form.querySelector('input[name="MinPrice"]');
                                    const maxEl = form.querySelector('input[name="MaxPrice"]');

                                    function validate() {
                                        const min = parseFloat(minEl.value);
                                        const max = parseFloat(maxEl.value);
                                        const bothNumbers = !Number.isNaN(min) && !Number.isNaN(max);
                                        if (bothNumbers && min > max) {
                                            maxEl.setCustomValidity('Maksimum fiyat, minimumdan kÃ¼Ã§Ã¼k olamaz.');
                                            maxEl.classList.add('is-invalid');
                                            return false;
                                        } else {
                                            maxEl.setCustomValidity('');
                                            maxEl.classList.remove('is-invalid');
                                            return true;
                                        }
                                    }

                                    minEl.addEventListener('input', validate);
                                    maxEl.addEventListener('input', validate);

                                    form.addEventListener('submit', function (e) {
                                        if (!validate()) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            form.classList.add('was-validated');
                                            maxEl.focus();
                                        }
                                    }, false);
                                })();
                        </script>

                        <script>
                                // SÄ±ralama dropdown davranÄ±ÅŸÄ±
                                (function () {
                                    const form = document.getElementById('priceForm');
                                    const hidden = document.getElementById('sortByHidden');
                                    const btn = document.getElementById('sortDropdownBtn');

                                    if (!form || !hidden || !btn) return;

                                    document.querySelectorAll('.sort-option').forEach(opt => {
                                        opt.addEventListener('click', function () {
                                            const val = this.getAttribute('data-value');
                                            const text = this.textContent.trim();

                                            hidden.value = val || "";
                                            btn.textContent = text;

                                            // Sayfa numarasÄ±nÄ± 1'e Ã§ekelim (yeni sÄ±ralama)
                                            const pageNumberInput = form.querySelector('input[name="PageNumber"]');
                                            if (pageNumberInput) pageNumberInput.value = "1";

                                            form.submit();
                                        });
                                    });
                                })();
                        </script>
                        <script>
(function () {
  const btn = document.getElementById("btnLoadMore");
  const grid = document.getElementById("productGrid");
  if (!btn || !grid) return;

  btn.addEventListener("click", async function () {
    const nextPage = parseInt(btn.dataset.nextPage || "2", 10);

    const qs = new URLSearchParams(window.location.search);

    // QueryString'den filtreleri al (yoksa boÅŸ)
    const pageSize = qs.get("PageSize") || "@Model.Pagination.ItemsPerPage";
    const categoryId = qs.get("CategoryId") || "";
    const searchTerm = qs.get("SearchTerm") || "";
    const minPrice = qs.get("MinPrice") || "";
    const maxPrice = qs.get("MaxPrice") || "";
    const sortBy = qs.get("SortBy") || "";

    btn.disabled = true;
    btn.textContent = "YÃ¼kleniyor...";

    const url =
      `/Product/LoadMore?PageNumber=${nextPage}&PageSize=${pageSize}` +
      `&CategoryId=${encodeURIComponent(categoryId)}` +
      `&SearchTerm=${encodeURIComponent(searchTerm)}` +
      `&MinPrice=${encodeURIComponent(minPrice)}` +
      `&MaxPrice=${encodeURIComponent(maxPrice)}` +
      `&SortBy=${encodeURIComponent(sortBy)}`;

    const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });

    if (!res.ok) {
      btn.disabled = false;
      btn.textContent = "Daha fazla yÃ¼kle";
      return;
    }

    const html = await res.text();
    if (html.trim()) {
      grid.insertAdjacentHTML("beforeend", html);
      btn.dataset.nextPage = String(nextPage + 1);
    }

    const hasMore = res.headers.get("X-HasMore") === "true";
    if (!hasMore) {
     const wrap = document.querySelector(".loadmore-wrap");
btn.remove();

const done = document.createElement("div");
done.className = "loadmore-done rounded-pill px-4 py-2";
done.textContent = "TÃ¼mÃ¼ yÃ¼klendi";

wrap?.appendChild(done);
return;

    }

    btn.disabled = false;
    btn.textContent = "Daha fazla yÃ¼kle";
  });
})();
</script>




                    }

                    <style>
                        /* --- Kategori ÅŸeridi --- */
                        .chips {
                            scrollbar-width: none;
                        }

                        .chips::-webkit-scrollbar {
                            display: none;
                        }

                        .chips .btn {
                            white-space: nowrap;
                        }

                        .category-bar {
                            row-gap: .5rem;
                        }

                        /* âœ… Arama Bilgi Banner Stilleri */
                        .alert-info {
                            background-color: #e7f3ff;
                            border-color: #b3d9ff;
                            color: #004085;
                        }

                        .alert-info i {
                            color: #001f5c;
                        }

                        .alert-info strong {
                            color: #001f5c;
                            font-size: 1rem;
                        }

                        .alert-info .btn-outline-secondary {
                            border-color: #6c757d;
                            color: #6c757d;
                            transition: all 0.3s ease;
                        }

                        .alert-info .btn-outline-secondary:hover {
                            background-color: #6c757d;
                            color: white;
                        }

                        /* âœ… ÃœrÃ¼n BulunamadÄ± EkranÄ± */
                        .card {
                            border-radius: 12px;
                        }

                        .fa-search.opacity-50 {
                            opacity: 0.3 !important;
                        }

                        /* âœ… Responsive */
                        @@media (max-width: 576px) {
                            .alert-info {
                                flex-direction: column;
                                gap: 1rem;
                                text-align: center;
                            }

                            .alert-info .d-flex:first-child {
                                flex-direction: column;
                                text-align: center;
                            }

                            .alert-info .btn {
                                width: 100%;
                            }

                            .card-body.py-5 {
                                padding-top: 2rem !important;
                                padding-bottom: 2rem !important;
                            }

                            .fa-search {
                                font-size: 2.5rem !important;
                            }
                        }

                        /* âœ… Navy renk */
                        .btn-navy {
                            background-color: #001f5c;
                            border-color: #001f5c;
                            color: white;
                        }

                        .btn-navy:hover {
                            background-color: #00153d;
                            border-color: #00153d;
                            color: white;
                        }

                        .btn-outline-navy {
                            color: #001f5c;
                            border-color: #001f5c;
                        }

                        .btn-outline-navy:hover {
                            background-color: #001f5c;
                            border-color: #001f5c;
                            color: white;
                        }

                        .text-navy {
                            color: #001f5c !important;
                        }

                        /* âœ… Dropdown z-index dÃ¼zeltmesi */
                        .dropdown-menu {
                            z-index: 1050 !important;
                        }

                        #priceFilter {
                            position: relative;
                            z-index: 1030;
                        }

                        .sort-dropdown-menu {
                            max-height: 300px;
                            overflow-y: auto;
                        }
                    </style>