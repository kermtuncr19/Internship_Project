@model Product
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

@functions {
    string GetDisplayName(Review review)
    {
        if (review.ShowFullName)
        {
            var profile = ViewBag.UserProfiles as Dictionary<string, string>;
            if (profile != null && profile.ContainsKey(review.UserId))
            {
                return profile[review.UserId];
            }
            return review.User?.Email?.Split('@').FirstOrDefault() ?? "Kullanıcı";
        }
        else
        {
            var profile = ViewBag.UserProfiles as Dictionary<string, string>;
            string fullName = "Kullanıcı";
            if (profile != null && profile.ContainsKey(review.UserId))
            {
                fullName = profile[review.UserId];
            }
            else if (review.User?.Email != null)
            {
                fullName = review.User.Email.Split('@').FirstOrDefault() ?? "Kullanıcı";
            }

            var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
            {
                var firstName = parts[0].Length >= 2 ? parts[0].Substring(0, 2) + new string('*', parts[0].Length - 2) : parts[0];
                var lastName = parts[1].Length >= 2 ? parts[1].Substring(0, 2) + new string('*', parts[1].Length - 2) : parts[1];
                return $"{firstName} {lastName}";
            }

            return fullName.Length >= 2 ? fullName.Substring(0, 2) + "***" : fullName;
        }
    }
}

@{
    // Ortalama puan & yorumlar
    var avgRating = Model.Reviews?.Any(r => r.IsApproved) == true
        ? Model.Reviews.Where(r => r.IsApproved).Average(r => r.Rating)
        : 0;

    var reviewCount = Model.Reviews?.Count(r => r.IsApproved) ?? 0;
    var approvedReviews = Model.Reviews?.Where(r => r.IsApproved)
                                        .OrderByDescending(r => r.CreatedAt)
                                        .ToList()
                         ?? new List<Review>();

    // Yıldız dağılımı (5 -> 1)
    var starCounts = new Dictionary<int, int>();
    for (int s = 1; s <= 5; s++)
    {
        starCounts[s] = approvedReviews.Count(rv => rv.Rating == s);
    }
}

<div class="container py-4">

    <!-- Ürün başlığı -->
    <h1 class="display-6 text-center mb-4">@Model.ProductName</h1>

    @if (TempData["CartError"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="alert alert-warning text-center" role="alert">@err</div>
    }

    <!-- ÜST BLOK: Sol görseller, sağ bilgi paneli -->
    <div class="row g-4 align-items-start">
        <!-- Sol: Galeri -->
        <div class="col-lg-7">
            <div class="product-gallery bg-white rounded shadow-sm p-3">
                <div class="main-image-container position-relative">
                    @{
                        var images = Model.Images?.OrderBy(i => i.DisplayOrder).ToList() ?? new List<ProductImage>();
                        var mainImage = images.FirstOrDefault(i => i.IsMain) ?? images.FirstOrDefault();
                        var mainImageUrl = mainImage?.ImageUrl ?? Model.ImageUrl ?? "/images/default.jpg";
                    }

                    <div id="zoomIcon" class="zoom-icon">
                        <i class="fa fa-search-plus"></i>
                    </div>

                    <div id="imageWrapper" class="image-zoom-wrapper">
                        <img id="mainImage"
                             class="img-fluid rounded shadow-sm w-100"
                             src="@mainImageUrl"
                             alt="@Model.ProductName"
                             style="max-height:560px; object-fit:contain; transition: opacity 0.3s;" />
                        <div id="zoomLens" class="zoom-lens"></div>
                    </div>

                    <div id="zoomResult" class="zoom-result"></div>

                    @if (images.Count > 1)
                    {
                        <button id="prevBtn" class="gallery-nav-btn gallery-nav-left">
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        <button id="nextBtn" class="gallery-nav-btn gallery-nav-right">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    }
                </div>

                @if (images.Count > 1)
                {
                    <div class="thumbnail-container mt-3 d-flex gap-2 justify-content-center flex-wrap">
                        @for (int i = 0; i < images.Count; i++)
                        {
                            var img = images[i];
                            <img src="@img.ImageUrl"
                                 class="thumbnail @(i == 0 ? "active" : "")"
                                 alt="@Model.ProductName"
                                 data-index="@i"
                                 style="width:80px; height:80px; object-fit:cover; cursor:pointer;
                                        border:2px solid transparent; border-radius:8px; transition: all 0.3s;" />
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Sağ: Fiyat, puan, beden, sepete ekle -->
        <div class="col-lg-5">
            <div class="bg-white rounded shadow-sm p-4 h-100 d-flex flex-column">

                <!-- Fiyat + Favori -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="fs-3 text-primary fw-semibold m-0">
                        @Model.Price.ToString("c")
                    </div>

                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        var isFavorite = ViewBag.IsFavorite ?? false;
                        <form class="m-0 p-0 d-inline js-fav-form" id="favForm-@Model.ProductId">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@Model.ProductId" />
                            <button type="button"
                                    class="btn p-0 border-0 bg-transparent js-fav-btn"
                                    data-url="@Url.Action("ToggleAjax","Favorites")"
                                    data-id="@Model.ProductId"
                                    aria-pressed="@(isFavorite.ToString().ToLower())"
                                    style="line-height:1;">
                                <i class="fav-icon @(isFavorite ? "fa-solid" : "fa-regular") fa-heart fa-lg"
                                   style="@(isFavorite ? "color:#dc3545;" : "color:#0d1b4c;") cursor:pointer; transition:color .2s;"></i>
                            </button>
                        </form>
                    }
                </div>

                <!-- Yıldızlar + puan -->
                <div class="d-flex align-items-center gap-1 mb-3">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (reviewCount > 0)
                        {
                            if (i <= Math.Floor(avgRating))
                            {
                                <i class="fa fa-star" style="color: #ffc107; font-size: 1.2rem;"></i>
                            }
                            else if (i == Math.Ceiling(avgRating) && avgRating % 1 != 0)
                            {
                                <i class="fa fa-star-half-alt" style="color: #ffc107; font-size: 1.2rem;"></i>
                            }
                            else
                            {
                                <i class="fa fa-star" style="color: #ddd; font-size: 1.2rem;"></i>
                            }
                        }
                        else
                        {
                            <i class="fa fa-star" style="color: #ddd; font-size: 1.2rem;"></i>
                        }
                    }

                    @if (reviewCount > 0)
                    {
                        <span class="text-muted small ms-2">@avgRating.ToString("0.0") (@reviewCount Değerlendirme)</span>
                    }
                    else
                    {
                        <span class="text-muted small ms-2">(Henüz Değerlendirme Yok)</span>
                    }
                </div>

                <!-- Sepete Ekle formu -->
                <form id="addToCartForm" class="mt-2 flex-grow-1 d-flex flex-column" method="post" asp-page="/cart">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="ProductId" />
                    <input type="hidden" name="returnUrl" value="@ViewContext.HttpContext.Request.PathAndQuery()" />

                    @{
                        var requires = Model.RequiresSize;
                        List<string> sizeList = new();
                        if (requires)
                        {
                            var csv = (Model.SizeOptionsCsv ?? "").Trim();
                            sizeList = string.IsNullOrWhiteSpace(csv)
                                ? new List<string> { "XS","S","M","L","XL" }
                                : csv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                                     .ToList();
                        }
                        var showSizes = requires && sizeList.Count > 0;
                    }

                    @if (showSizes)
                    {
                        <div class="mb-3">
                            <div class="small text-muted mb-2">Beden Seçin</div>
                            <fieldset class="size-list d-flex flex-wrap gap-2" role="radiogroup" aria-label="Beden Seçimi">
                                @foreach (var s in sizeList)
                                {
                                    var id = $"size_{s}";
                                    <div class="size-chip">
                                        <input type="radio" id="@id" name="size" value="@s" class="visually-hidden" />
                                        <label for="@id" class="size-btn">@s</label>
                                    </div>
                                }
                            </fieldset>
                        </div>
                    }

                    <div class="mb-3">
                        <button id="addToCartBtn"
                                type="submit"
                                class="btn btn-navy btn-pill w-100 py-2"
                                @(Model.RequiresSize ? "disabled" : null)>
                            <i class="fa fa-cart-plus me-1"></i> Sepete Ekle
                        </button>
                    </div>

                    <div class="small text-muted mb-3">
                        <i class="fa fa-truck me-1"></i>
                        2000 ₺ üzeri alışverişlerde kargo ücretsiz.
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ALT BLOK: Detaylar / Yorumlar / Tartışma sekmeleri -->
<div class="container py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <!-- Sekme başlıkları: modern nav-pills -->
            <ul class="nav nav-pills justify-content-center mb-4 product-tabs" id="productTabs" role="tablist"
                style="gap:0.5rem;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active px-4 py-2"
                            id="details-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#details"
                            type="button"
                            role="tab"
                            aria-controls="details"
                            aria-selected="true">
                        Detaylar
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link px-4 py-2"
                            id="reviews-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#reviews"
                            type="button"
                            role="tab"
                            aria-controls="reviews"
                            aria-selected="false">
                        Yorumlar
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link px-4 py-2"
                            id="discussion-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#discussion"
                            type="button"
                            role="tab"
                            aria-controls="discussion"
                            aria-selected="false">
                        Tartışma
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="productTabsContent">
                <!-- Detaylar sekmesi -->
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white fw-semibold">Ürün Bilgileri</div>
                        <div class="card-body">
                            @if (!string.IsNullOrWhiteSpace(Model?.Summary))
                            {
                                <div class="small text-muted" style="white-space: pre-line; line-height:1.7;">
                                    @Model.Summary
                                </div>
                            }
                            else
                            {
                                <p class="mb-0 text-muted fst-italic">
                                    Bu ürün için detaylar yakında eklenecek.
                                </p>
                            }
                        </div>
                    </div>
                </div>

                <!-- Yorumlar sekmesi -->
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    <h4 class="mb-3">Müşteri Değerlendirmeleri</h4>

                    @if (reviewCount > 0)
                    {
                        <!-- Üstte ortalama & dağılım -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <div class="row g-4 align-items-center">
                                    <!-- Sol: ortalama puan -->
                                    <div class="col-md-4 text-center border-end-md">
                                        <div class="display-4 fw-bold text-primary mb-2">
                                            @avgRating.ToString("0.0")
                                        </div>
                                        <div class="mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= Math.Floor(avgRating))
                                                {
                                                    <i class="fa fa-star" style="color: #ffc107; font-size: 1.4rem;"></i>
                                                }
                                                else if (i == Math.Ceiling(avgRating) && avgRating % 1 != 0)
                                                {
                                                    <i class="fa fa-star-half-alt" style="color: #ffc107; font-size: 1.4rem;"></i>
                                                }
                                                else
                                                {
                                                    <i class="fa fa-star" style="color: #ddd; font-size: 1.4rem;"></i>
                                                }
                                            }
                                        </div>
                                        <div class="text-muted">@reviewCount Değerlendirme</div>
                                    </div>

                                    <!-- Sağ: dağılım barları -->
                                    <div class="col-md-8">
                                        @for (int star = 5; star >= 1; star--)
                                        {
                                            var count = starCounts.ContainsKey(star) ? starCounts[star] : 0;
                                            var percent = reviewCount > 0 ? (count * 100.0 / reviewCount) : 0;

                                            <div class="d-flex align-items-center mb-1">
                                                <div style="width:1.5rem;" class="small text-muted">@star</div>
                                                <div class="flex-grow-1 mx-2">
                                                    <div class="progress" style="height:8px; background-color:#f1f1f1;">
                                                        <div class="progress-bar"
                                                             role="progressbar"
                                                             style="width:@percent.ToString("0")%; background-color:#ffc107;">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="small text-muted" style="width:2rem; text-align:right;">
                                                    @count
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Yorum kartları -->
                        <div class="reviews-list">
                            @foreach (var review in approvedReviews)
                            {
                                <div class="card shadow-sm mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <div class="fw-semibold">@GetDisplayName(review)</div>
                                                <div class="small text-muted">
                                                    @review.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")
                                                </div>
                                            </div>
                                            <div>
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fa fa-star"
                                                       style="color: @(i <= review.Rating ? "#ffc107" : "#ddd");"></i>
                                                }
                                            </div>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(review.Comment))
                                        {
                                            <p class="mb-0" style="white-space: pre-line;">@review.Comment</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="card shadow-sm">
                            <div class="card-body text-center py-5 text-muted">
                                <i class="fa fa-star-o fa-3x mb-3 opacity-50"></i>
                                <div>Bu ürün için henüz değerlendirme yapılmamış.</div>
                                <div class="small mt-2">İlk değerlendirmeyi siz yapın!</div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Tartışma sekmesi -->
                <div class="tab-pane fade" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                    <div class="card shadow-sm">
                        <div class="card-body text-muted">
                            Bu bölümde ürünle ilgili soru-cevap ve tartışmalar yer alacak.
                            <span class="d-block small mt-1">Bu özellik yakında eklenecek.</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- İlgili ürünler: EN ALTA ALINDI -->
@await Component.InvokeAsync("RelatedProducts", new { productId = Model.ProductId, categoryId = Model.CategoryId })

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const imageWrapper = document.getElementById('imageWrapper');
            const zoomLens = document.getElementById('zoomLens');
            const zoomResult = document.getElementById('zoomResult');
            const zoomIcon = document.getElementById('zoomIcon');

            if (!mainImage) return;

            let currentIndex = 0;
            const totalImages = thumbnails.length;
            let isZoomActive = false;

            imageWrapper.addEventListener('click', function (e) {
                if (e.target.closest('.gallery-nav-btn')) return;

                isZoomActive = !isZoomActive;

                if (isZoomActive) {
                    imageWrapper.classList.add('zoom-active');
                    initZoom();
                } else {
                    imageWrapper.classList.remove('zoom-active');
                    removeZoomListeners();
                }
            });

            let moveHandler = null;

            function initZoom() {
                let cx = zoomResult.offsetWidth / zoomLens.offsetWidth;
                let cy = zoomResult.offsetHeight / zoomLens.offsetHeight;

                zoomResult.style.backgroundImage = "url('" + mainImage.src + "')";
                zoomResult.style.backgroundSize =
                    (mainImage.width * cx) + "px " + (mainImage.height * cy) + "px";

                moveHandler = function (e) {
                    moveLens(e);
                };

                imageWrapper.addEventListener('mousemove', moveHandler);

                function moveLens(e) {
                    e.preventDefault();
                    let pos = getCursorPos(e);
                    let x = pos.x - (zoomLens.offsetWidth / 2);
                    let y = pos.y - (zoomLens.offsetHeight / 2);

                    if (x > imageWrapper.offsetWidth - zoomLens.offsetWidth) {
                        x = imageWrapper.offsetWidth - zoomLens.offsetWidth;
                    }
                    if (x < 0) { x = 0; }
                    if (y > imageWrapper.offsetHeight - zoomLens.offsetHeight) {
                        y = imageWrapper.offsetHeight - zoomLens.offsetHeight;
                    }
                    if (y < 0) { y = 0; }

                    zoomLens.style.left = x + "px";
                    zoomLens.style.top = y + "px";
                    zoomResult.style.backgroundPosition =
                        "-" + (x * cx) + "px -" + (y * cy) + "px";
                }

                function getCursorPos(e) {
                    let a, x = 0, y = 0;
                    e = e || window.event;
                    a = imageWrapper.getBoundingClientRect();
                    x = e.pageX - a.left;
                    y = e.pageY - a.top;
                    x = x - window.pageXOffset;
                    y = y - window.pageYOffset;
                    return { x: x, y: y };
                }
            }

            function removeZoomListeners() {
                if (moveHandler) {
                    imageWrapper.removeEventListener('mousemove', moveHandler);
                    moveHandler = null;
                }
            }

            function updateImage(index) {
                if (thumbnails.length === 0) return;

                isZoomActive = false;
                imageWrapper.classList.remove('zoom-active');
                removeZoomListeners();

                mainImage.style.opacity = '0';
                setTimeout(function () {
                    mainImage.src = thumbnails[index].src;
                    mainImage.style.opacity = '1';
                    thumbnails.forEach(function (t) { t.classList.remove('active'); });
                    thumbnails[index].classList.add('active');
                    currentIndex = index;
                }, 150);
            }

            thumbnails.forEach(function (thumb, index) {
                thumb.addEventListener('click', function () { updateImage(index); });
            });

            if (prevBtn) {
                prevBtn.addEventListener('click', function () {
                    const newIndex = (currentIndex - 1 + totalImages) % totalImages;
                    updateImage(newIndex);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function () {
                    const newIndex = (currentIndex + 1) % totalImages;
                    updateImage(newIndex);
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowLeft' && prevBtn) prevBtn.click();
                if (e.key === 'ArrowRight' && nextBtn) nextBtn.click();
            });

            const requires = @(Model.RequiresSize.ToString().ToLowerInvariant());
            const form = document.getElementById('addToCartForm');
            if (!form) return;

            const radios = form.querySelectorAll('input[name="size"]');
            const button = document.getElementById('addToCartBtn');

            if (requires && radios.length > 0) {
                function syncState() {
                    const anyChecked =
                        Array.from(radios).some(function (r) { return r.checked; });
                    button.disabled = !anyChecked;
                }
                radios.forEach(function (r) { r.addEventListener('change', syncState); });
                syncState();
            }
        });

        // Favori toggle
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.js-fav-btn');
            if (!btn) return;

            const form = btn.closest('.js-fav-form');
            const icon = btn.querySelector('.fav-icon');
            if (!form || !icon) return;

            const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : null;
            const url = btn.getAttribute('data-url');
            const productId = Number(btn.getAttribute('data-id') || 0);

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        ...(token ? { 'RequestVerificationToken': token } : {})
                    },
                    body: JSON.stringify({ ProductId: productId })
                });

            if (!res.ok) {
                console.error('Fav toggle HTTP error', res.status);
                return;
            }

            const ct = res.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                window.location.reload();
                return;
            }

            const data = await res.json();
            if (data && data.isFavorite === true) {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                icon.style.color = '#dc3545';
            } else if (data && data.isFavorite === false) {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                icon.style.color = '#0d1b4c';
            }
        } catch (err) {
            console.error('Favorites toggle failed', err);
        }
    });
    </script>
}
